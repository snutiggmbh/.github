name: Sync PR template to all org repos

on:
  workflow_dispatch: {}
  schedule:
    - cron: "0 3 * * *" # every Day at 03:00 UTC

jobs:
  sync-template:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout .github repo
        uses: actions/checkout@v4

      - name: Set up Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: List repos in org
        env:
          ORG: snutiggmbh
          TOKEN: ${{ secrets.ORG_REPOS_PAT }}
        run: |
          page=1
          > repos.txt
          while : ; do
            response=$(curl -s -H "Authorization: token $TOKEN" \
              "https://api.github.com/orgs/$ORG/repos?per_page=100&page=$page")
            
            # Break if empty array
            if [ "$(echo "$response" | jq 'length')" -eq 0 ]; then
              break
            fi

            # Filter out archived repos if you don't want to touch them
            echo "$response" | jq -r '.[] | select(.archived == false) | .name' >> repos.txt

            page=$((page+1))
          done

          echo "Repos:"
          cat repos.txt

      - name: Sync template to each repo
        env:
          ORG: snutiggmbh
          TOKEN: ${{ secrets.ORG_REPOS_PAT }}
        run: |
          TEMPLATE_PATH=".github/pull_request_template.md"

          if [ ! -f "$TEMPLATE_PATH" ]; then
            echo "Template file $TEMPLATE_PATH not found in .github repo"
            exit 1
          fi

          while read -r REPO; do
            echo "Processing $ORG/$REPO ..."

            # Clone repo with PAT
            git clone "https://$TOKEN@github.com/$ORG/$REPO.git"
            cd "$REPO"

            # Create .github directory if missing
            mkdir -p .github

            # Copy template
            cp "../$TEMPLATE_PATH" ".github/pull_request_template.md"

            # Check for changes
            if git status --porcelain | grep -q ".github/pull_request_template.md"; then
              git checkout -b chore/sync-pr-template || git checkout chore/sync-pr-template

              git add .github/pull_request_template.md
              git commit -m "chore: sync pull request template from .github org repo" || echo "Nothing to commit"

              # Push branch
              git push -u origin chore/sync-pr-template || echo "Push failed"

              # Create PR via API
              curl -s -X POST \
                -H "Authorization: token $TOKEN" \
                -H "Accept: application/vnd.github+json" \
                "https://api.github.com/repos/$ORG/$REPO/pulls" \
                -d @- <<EOF
              {
                "title": "chore: sync pull request template",
                "head": "chore/sync-pr-template",
                "base": "main",
                "body": "This PR updates .github/pull_request_template.md from the org-wide canonical template in the .github repository."
              }
EOF

            else
              echo "No changes for $ORG/$REPO"
            fi

            cd ..
            rm -rf "$REPO"
          done < repos.txt
