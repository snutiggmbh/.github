name: Sync PR template to all private org repos

on:
  workflow_dispatch: {}
  schedule:
    - cron: "0 3 * * *" # every Monday at 03:00 UTC; adjust or remove if not needed

jobs:
  sync-template:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout .github repo
        uses: actions/checkout@v4

      - name: Set up Git identity
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Collect private repos in org
        env:
          ORG: snutiggmbh
          TOKEN: ${{ secrets.ORG_REPOS_PAT }}
        run: |
          page=1
          > repos.txt

          while : ; do
            echo "Fetching page $page ..."
            response=$(curl -s -H "Authorization: token $TOKEN" \
              "https://api.github.com/orgs/$ORG/repos?per_page=100&page=$page")

            # Stop when empty array returned
            if [ "$(echo "$response" | jq 'length')" -eq 0 ]; then
              break
            fi

            # only private, non-archived repos; store as "name default_branch"
            echo "$response" | jq -r '
              .[] 
              | select(.private == true and .archived == false) 
              | "\(.name) \(.default_branch)"
            ' >> repos.txt

            page=$((page+1))
          done

          echo "Repos discovered:"
          cat repos.txt

      - name: Sync template and push directly
        env:
          ORG: snutiggmbh
          TOKEN: ${{ secrets.ORG_REPOS_PAT }}
        run: |
          TEMPLATE_SOURCE=".github/pull_request_template.md"

          if [ ! -f "$TEMPLATE_SOURCE" ]; then
            echo "Template file $TEMPLATE_SOURCE not found in .github repo"
            exit 1
          fi

          while read -r REPO_NAME DEFAULT_BRANCH; do
            echo "----------------------------------------"
            echo "Processing $ORG/$REPO_NAME (default: $DEFAULT_BRANCH)"

            # Clone repo with PAT
            git clone "https://$TOKEN@github.com/$ORG/$REPO_NAME.git"
            cd "$REPO_NAME"

            TARGET_BRANCH="$DEFAULT_BRANCH"
            TARGET_FILE=".github/pull_request_template.md"

            # Check if repo is empty (no commits / no HEAD)
            if ! git rev-parse HEAD >/dev/null 2>&1; then
              echo "Repo $ORG/$REPO_NAME appears to be empty. Creating $TARGET_BRANCH from scratch."
              git checkout -b "$TARGET_BRANCH"
            else
              # Repo has commits. Ensure we are on the default branch.
              # First fetch any remote updates
              git fetch origin

              # If the default branch exists on remote, track it; otherwise create it locally
              if git show-ref --verify --quiet "refs/remotes/origin/$TARGET_BRANCH"; then
                echo "Checking out existing default branch $TARGET_BRANCH"
                git checkout "$TARGET_BRANCH"
                git pull origin "$TARGET_BRANCH"
              else
                echo "Default branch $TARGET_BRANCH does not exist on remote, creating local branch."
                git checkout -b "$TARGET_BRANCH"
              fi
            fi

            # Make sure we have the latest default branch
            git fetch origin "$DEFAULT_BRANCH"
            git checkout "$DEFAULT_BRANCH"

            # OPTIONAL: skip repos that already have a template
            # Uncomment this block if you *never* want to overwrite:
            # if [ -f "$TARGET_FILE" ]; then
            #   echo "Template already exists in $ORG/$REPO_NAME, skipping."
            #   cd ..
            #   rm -rf "$REPO_NAME"
            #   continue
            # fi

            # Ensure .github exists
            mkdir -p .github

            # Copy template from .github org repo
            cp "../$TEMPLATE_SOURCE" "$TARGET_FILE"

            # Check if there is any actual change
            if git status --porcelain | grep -q "$TARGET_FILE"; then
              echo "Template changed in $ORG/$REPO_NAME, committing and pushing ..."

              git add "$TARGET_FILE"
              git commit -m "chore: sync pull request template from org .github repository [skip actions]" || echo "Nothing to commit"

              # If there were no staged changes, skip push
              if git log -1 --pretty=%B | grep -q "chore: sync pull request template from org .github repository"; then
                git push origin "$DEFAULT_BRANCH"
              else
                echo "No new commit created, skipping push."
              fi
            else
              echo "No changes for $ORG/$REPO_NAME"
            fi

            cd ..
            rm -rf "$REPO_NAME"
          done < repos.txt
